# ูุธุงู ุงูุชุฏููุงุช ุงูุฏููุงูููู ุงูุดุงูู
## Universal Dynamic Flows System

## ๐ ูุธุฑุฉ ุนุงูุฉ

ูุธุงู ุงูุชุฏููุงุช ุงูุฏููุงูููู ูู ูุธุงู ุดุงูู ูุนูู ูู **ุฃู ุฌุฒุก ูู ุงููุดุฑูุน** ููููู ุงุณุชุฎุฏุงูู ูุฃู ุณููุงุฑูู ุจุฏูู ุงูุญุงุฌุฉ ููููุฏ. ูููู ูููุฏุฑุงุก ุฅูุดุงุก ูุฅุฏุงุฑุฉ ุงูุชุฏููุงุช ุงูุขููุฉ ูู ูุงุฌูุฉ Admin ุจุฏูู ูุชุงุจุฉ ุฃู ุณุทุฑ ุจุฑูุฌู.

## โจ ุงููููุฒุงุช ุงูุฑุฆูุณูุฉ

### 1. **ุฏููุงูููู ูุนุงู**
- โ ูุนูู ูู ุฃู ูุญุฏุฉ ูู ุงููุธุงู (ูุงุชุณุงุจุ ุงูููุงุนูุฏุ ุงููุฑุถูุ ุงูููุงุชูุฑุ ุฅูุฎ)
- โ ูุง ููุชุตุฑ ุนูู ูุงุชุณุงุจ ููุท
- โ ูููู ุงุณุชุฎุฏุงูู ูุฃู ุณููุงุฑูู

### 2. **ุจุฏูู ููุฏ (No-Code)**
- โ ูุงุฌูุฉ Visual Builder ุณููุฉ ุงูุงุณุชุฎุฏุงู
- โ ุฅุถุงูุฉ ุงูุนูุฏ ุนุจุฑ ุงูููุฑ
- โ ุชูููู ุงูุนูุฏ ุนุจุฑ ุงูููุงุฐุฌ
- โ ูุง ุญุงุฌุฉ ููุนุฑูุฉ ุจุฑูุฌูุฉ

### 3. **ููู ููุฑู**
- โ ุฃููุงุน ุนูุฏ ูุชุนุฏุฏุฉ (AIุ ูุงุนุฏุฉ ุงูุจูุงูุงุชุ APIุ ุฅุดุนุงุฑุงุชุ ุฅูุฎ)
- โ ุฏุนู ุงูุดุฑูุท ูุงูููุทู ุงูุดุฑุทู
- โ ุชูููุฐ ูุชุฒุงูู ุฃู ุบูุฑ ูุชุฒุงูู
- โ ุฅุนุงุฏุฉ ุงููุญุงููุฉ ุงูุชููุงุฆูุฉ

### 4. **ุชูุงูู ุณูุณ**
- โ ููุงุท ุชูุงูู ูู ุฌููุน ุฃูุญุงุก ุงููุธุงู
- โ ุชูููุฐ ุชููุงุฆู ุนูุฏ ุญุฏูุซ ุงูุฃุญุฏุงุซ
- โ ุณุฌูุงุช ุชูููุฐ ููุตูุฉ

## ๐๏ธ ูููู ูุงุนุฏุฉ ุงูุจูุงูุงุช

### ุฌุฏูู `flows`
```sql
- id: UUID
- name: TEXT (ุงุณู ุงูุชุฏูู)
- description: TEXT
- module: TEXT (ุงููุญุฏุฉ: whatsapp, appointments, patients, etc.)
- category: TEXT
- trigger_type: TEXT (ููุน ุงููุดุบู)
- trigger_config: JSONB (ุฅุนุฏุงุฏุงุช ุงููุดุบู)
- nodes: JSONB (ุนูุฏ ุงูุชุฏูู)
- edges: JSONB (ุงูุฑูุงุจุท ุจูู ุงูุนูุฏ)
- execution_mode: TEXT (sync/async/background)
- ai_enabled: BOOLEAN
- ai_model: TEXT
- ai_prompt: TEXT
- is_active: BOOLEAN
- priority: INTEGER
- tags: TEXT[]
- metadata: JSONB
```

### ุฌุฏูู `flow_executions`
```sql
- id: UUID
- flow_id: UUID
- context_type: TEXT (ููุน ุงูุณูุงู)
- context_id: UUID (ูุนุฑู ุงูุณูุงู)
- context_data: JSONB (ุจูุงูุงุช ุงูุณูุงู)
- status: TEXT (running/completed/failed)
- current_node_id: TEXT
- node_results: JSONB
- input_data: JSONB
- output_data: JSONB
- error_message: TEXT
- started_at: TIMESTAMPTZ
- completed_at: TIMESTAMPTZ
```

## ๐ฏ ุฃููุงุน ุงูุนูุฏ ุงููุชุงุญุฉ

### 1. **Trigger (ุจุฏุงูุฉ)**
- ููุทุฉ ุจุฏุงูุฉ ุงูุชุฏูู
- ูุง ูุญุชุงุฌ ุฅุนุฏุงุฏุงุช

### 2. **Condition (ุดุฑุท)**
- ุชูููู ุดุฑุท ููุทูู
- ูุซุงู: `{{input.status}} == "active"`

### 3. **AI Analysis (ุชุญููู AI)**
- ุงุณุชุฎุฏุงู AI ูุชุญููู ุงูุจูุงูุงุช
- ูุฏุนู Gemini ู OpenAI

### 4. **Database Query (ุงุณุชุนูุงู)**
- ุงุณุชุนูุงู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- ุฏุนู ุงูููุงุชุฑ

### 5. **Database Update (ุชุญุฏูุซ)**
- ุชุญุฏูุซ ุณุฌูุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- ุฏุนู ุงูุชุญุฏูุซุงุช ุงูุฏููุงููููุฉ

### 6. **API Call (ุงุณุชุฏุนุงุก API)**
- ุงุณุชุฏุนุงุก APIs ุฎุงุฑุฌูุฉ
- ุฏุนู GET, POST, PUT, DELETE

### 7. **Notification (ุฅุดุนุงุฑ)**
- ุฅุฑุณุงู ุฅุดุนุงุฑุงุช (Email, SMS, Push)
- ุฏุนู ุงูููุงูุจ

### 8. **Delay (ุชุฃุฎูุฑ)**
- ุชุฃุฎูุฑ ุงูุชูููุฐ
- ูููุฏ ููุนูููุงุช ุงููุฌุฏููุฉ

### 9. **Transform (ุชุญููู)**
- ุชุญููู ุงูุจูุงูุงุช
- ุฏุนู ุงููุชุบูุฑุงุช ุงูุฏููุงููููุฉ

## ๐ง ุฃููุงุน ุงููุดุบูุงุช (Triggers)

### 1. **Event (ุญุฏุซ)**
- ูุชู ุงูุชูููุฐ ุนูุฏ ุญุฏูุซ ุญุฏุซ ูุนูู
- ูุซุงู: ุฑุณุงูุฉ ูุงุชุณุงุจ ุฌุฏูุฏุฉ

### 2. **Webhook**
- ูุชู ุงูุชูููุฐ ุนูุฏ ุงุณุชุฏุนุงุก webhook

### 3. **Condition (ุดุฑุท)**
- ูุชู ุงูุชูููุฐ ุนูุฏ ุชุญูู ุดุฑุท ูุนูู

### 4. **API Call**
- ูุชู ุงูุชูููุฐ ุนูุฏ ุงุณุชุฏุนุงุก API

### 5. **Database Change**
- ูุชู ุงูุชูููุฐ ุนูุฏ ุชุบููุฑ ูุงุนุฏุฉ ุงูุจูุงูุงุช

### 6. **User Action**
- ูุชู ุงูุชูููุฐ ุนูุฏ ุฅุฌุฑุงุก ูุณุชุฎุฏู

### 7. **AI Detection**
- ูุชู ุงูุชูููุฐ ุนูุฏ ูุดู AI ูููุท ูุนูู

### 8. **Time Based**
- ูุชู ุงูุชูููุฐ ูู ููุช ูุญุฏุฏ

## ๐ ููุงุท ุงูุชูุงูู

### 1. **WhatsApp Webhook**
```typescript
// ูู app/api/whatsapp/route.ts
import { executeFlowsForContext } from '@/lib/flows'

// ุจุนุฏ ุญูุธ ุงูุฑุณุงูุฉ
executeFlowsForContext({
  context_type: 'whatsapp_conversation',
  context_id: conversation.id,
  input_data: {
    message: text,
    message_id: messageId,
    from: from,
  },
  triggered_by_type: 'webhook',
})
```

### 2. **Appointments API**
```typescript
// ูู app/api/appointments/route.ts
executeFlowsForContext({
  context_type: 'appointment',
  context_id: appointment.id,
  input_data: appointment,
  triggered_by_type: 'api',
})
```

### 3. **Patients API**
```typescript
// ูู app/api/patients/route.ts
executeFlowsForContext({
  context_type: 'patient',
  context_id: patient.id,
  input_data: patient,
  triggered_by_type: 'api',
})
```

## ๐จ ูุงุฌูุฉ Admin

### ุตูุญุฉ ุฅุฏุงุฑุฉ ุงูุชุฏููุงุช
- **ุงููุณุงุฑ**: `/dashboard/admin/flows`
- **ุงููููุฒุงุช**:
  - ุนุฑุถ ุฌููุน ุงูุชุฏููุงุช
  - ููุชุฑุฉ ุญุณุจ ุงููุญุฏุฉ ูุงููุฆุฉ
  - ุชูุนูู/ุชุนุทูู ุงูุชุฏููุงุช
  - ูุณุฎ ูุญุฐู ุงูุชุฏููุงุช

### ุตูุญุฉ Visual Builder
- **ุงููุณุงุฑ**: `/dashboard/admin/flows/builder`
- **ุงููููุฒุงุช**:
  - ุฅุถุงูุฉ ุนูุฏ ุจุงูููุฑ
  - ุชูููู ูู ุนูุฏุฉ
  - ุญูุธ ุงูุชุฏูู
  - ูุนุงููุฉ ุงูุชุฏูู

## ๐ ุฃูุซูุฉ ุงุณุชุฎุฏุงู

### ูุซุงู 1: ุฅุฏุงุฑุฉ ุงูููุงุนูุฏ ุนุจุฑ ุงููุงุชุณุงุจ
```
1. Trigger: ุฑุณุงูุฉ ูุงุชุณุงุจ ุฌุฏูุฏุฉ
2. AI Analysis: ุชุญููู ููุฉ ุงููุณุชุฎุฏู
3. Condition: ูู ูุฑูุฏ ุญุฌุฒ ููุนุฏุ
4. Database Query: ุฌูุจ ุงูููุงุนูุฏ ุงููุชุงุญุฉ
5. Database Update: ุฅูุดุงุก ููุนุฏ ุฌุฏูุฏ
6. Notification: ุฅุฑุณุงู ุชุฃููุฏ ูููุฑูุถ
```

### ูุซุงู 2: ุฅุดุนุงุฑ ุนูุฏ ุฅูุดุงุก ูุงุชูุฑุฉ
```
1. Trigger: ุฅูุดุงุก ูุงุชูุฑุฉ ุฌุฏูุฏุฉ
2. Database Query: ุฌูุจ ุจูุงูุงุช ุงููุฑูุถ
3. Condition: ูู ุงููุงุชูุฑุฉ > 1000ุ
4. Notification: ุฅุฑุณุงู ุฅุดุนุงุฑ ูููุฑูุถ
5. API Call: ูุฒุงููุฉ ูุน CRM
```

### ูุซุงู 3: ูุชุงุจุนุฉ ุงููุฑุถู
```
1. Trigger: ููุนุฏ ูุงุฏู ุฎูุงู 24 ุณุงุนุฉ
2. Database Query: ุฌูุจ ุจูุงูุงุช ุงูููุนุฏ
3. AI Analysis: ุฅูุดุงุก ุฑุณุงูุฉ ุชุฐููุฑ
4. Notification: ุฅุฑุณุงู ุฑุณุงูุฉ ูุงุชุณุงุจ
```

## ๐ ุงูุฃูุงู

- โ Row Level Security (RLS) ููุนู
- โ ููุท Admin ููููู ุฅูุดุงุก/ุชุนุฏูู ุงูุชุฏููุงุช
- โ ุณุฌูุงุช ุชูููุฐ ููุตูุฉ
- โ ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ุงูุขููุฉ

## ๐ ุงููุฑุงูุจุฉ

- โ ุณุฌูุงุช ุงูุชูููุฐ ูู `flow_executions`
- โ ุณุฌูุงุช ููุตูุฉ ูู `flow_logs`
- โ ุฅุญุตุงุฆูุงุช ุงูุชูููุฐ
- โ ุชุชุจุน ุงูุฃุฎุทุงุก

## ๐ ุงูุงุณุชุฎุฏุงู ุงูุณุฑูุน

### 1. ุฅูุดุงุก ุชุฏูู ุฌุฏูุฏ
1. ุงุฐูุจ ุฅูู `/dashboard/admin/flows`
2. ุงุถุบุท "ุฅูุดุงุก ุชุฏูู ุฌุฏูุฏ"
3. ุฃุฏุฎู ุงููุนูููุงุช ุงูุฃุณุงุณูุฉ
4. ุฃุถู ุงูุนูุฏ ุงููุทููุจุฉ
5. ูู ุจุชูููู ูู ุนูุฏุฉ
6. ุงุญูุธ ุงูุชุฏูู

### 2. ุชูุนูู ุงูุชุฏูู
1. ุงุฐูุจ ุฅูู ุตูุญุฉ ุงูุชุฏููุงุช
2. ุงุถุบุท ุนูู ุฒุฑ ุงูุชูุนูู
3. ุงูุชุฏูู ุณูุนูู ุชููุงุฆูุงู

### 3. ูุฑุงูุจุฉ ุงูุชูููุฐ
- ุฑุงุฌุน `flow_executions` ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- ุฑุงุฌุน `flow_logs` ููุชูุงุตูู

## ๐ API Endpoints

### GET `/api/flows`
- ุฌูุจ ุฌููุน ุงูุชุฏููุงุช
- ุฏุนู ุงูููุชุฑุฉ ุญุณุจ ุงููุญุฏุฉ ูุงููุฆุฉ

### POST `/api/flows`
- ุฅูุดุงุก ุชุฏูู ุฌุฏูุฏ

### GET `/api/flows/[id]`
- ุฌูุจ ุชุฏูู ูุญุฏุฏ

### PUT `/api/flows/[id]`
- ุชุญุฏูุซ ุชุฏูู

### DELETE `/api/flows/[id]`
- ุญุฐู ุชุฏูู

### POST `/api/flows/execute`
- ุชูููุฐ ุชุฏูู
- ูุณุชุฎุฏู ุฏุงุฎููุงู ูู `executeFlowsForContext`

## ๐ฏ ุงูุฎุทูุงุช ุงูุชุงููุฉ

1. โ ุฅูุดุงุก ูุธุงู ุงูุชุฏููุงุช ุงูุฃุณุงุณู
2. โ ูุงุฌูุฉ Visual Builder
3. โ ุชูุงูู ูุน WhatsApp
4. โณ ุชูุงูู ูุน ุจุงูู ุงููุญุฏุงุช
5. โณ ุฅุถุงูุฉ ุงููุฒูุฏ ูู ุฃููุงุน ุงูุนูุฏ
6. โณ ุชุญุณูู ูุงุฌูุฉ Builder
7. โณ ุฅุถุงูุฉ Templates ุฌุงูุฒุฉ

## ๐ ุงูุฏุนู

ูููุฒูุฏ ูู ุงููุนูููุงุช ุฃู ุงููุณุงุนุฏุฉุ ุฑุงุฌุน:
- `src/lib/flows.ts` - Helper functions
- `app/api/flows/execute/route.ts` - Execution engine
- `app/dashboard/admin/flows/` - Admin interface
