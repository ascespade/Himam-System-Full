#!/usr/bin/env sh
# Modern Husky v9+ - optimized for speed
# Only checks staged files, not entire codebase

set -e

echo "üîç Running pre-commit checks on staged files only..."

# Get list of staged TypeScript/TSX files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx)$' || true)

if [ -z "$STAGED_FILES" ]; then
  echo "‚úÖ No TypeScript files staged, skipping checks"
  exit 0
fi

FILE_COUNT=$(echo "$STAGED_FILES" | wc -l | tr -d ' ')
echo "üìã Checking $FILE_COUNT staged file(s)..."

# Run lint-staged (handles ESLint and tsc-files on staged files only)
# This is fast because it only processes staged files
echo "üîß Running lint-staged (ESLint + TypeScript check)..."
npx lint-staged || {
  echo "‚ùå Lint-staged checks failed. Please fix errors before committing."
  exit 1
}

# Quick pattern checks on staged files only (very fast)
echo "üö´ Checking for code hygiene violations..."

# Check for console.log in staged files (exclude allowed files)
CONSOLE_VIOLATIONS=$(echo "$STAGED_FILES" | xargs grep -l "console\.log" 2>/dev/null | grep -v -E "(logger\.ts|toast\.ts|page\.tsx|component\.tsx|\.test\.|\.spec\.)" || true)

if [ -n "$CONSOLE_VIOLATIONS" ]; then
  echo "‚ùå Found console.log in staged files:"
  echo "$CONSOLE_VIOLATIONS" | sed 's/^/   /'
  echo ""
  echo "   Replace with: import { logInfo } from '@/shared/utils/logger'"
  exit 1
fi

# Check for 'any' types in staged files (exclude test files and type definitions)
ANY_VIOLATIONS=$(echo "$STAGED_FILES" | xargs grep -l ": any\|as any" 2>/dev/null | grep -v -E "(\.test\.|\.spec\.|types\.ts|\.d\.ts|index\.ts)" || true)

if [ -n "$ANY_VIOLATIONS" ]; then
  echo "‚ùå Found 'any' types in staged files:"
  echo "$ANY_VIOLATIONS" | sed 's/^/   /'
  echo ""
  echo "   Use proper types instead of 'any'"
  exit 1
fi

# Check for select('*') in staged API routes only
API_ROUTES=$(echo "$STAGED_FILES" | grep "app/api.*route\.ts" || true)
if [ -n "$API_ROUTES" ]; then
  SELECT_STAR_VIOLATIONS=$(echo "$API_ROUTES" | xargs grep -l "select('\\*')" 2>/dev/null || true)
  
  if [ -n "$SELECT_STAR_VIOLATIONS" ]; then
    echo "‚ùå Found select('*') in staged API routes:"
    echo "$SELECT_STAR_VIOLATIONS" | sed 's/^/   /'
    echo ""
    echo "   Use specific column selections instead of select('*')"
    exit 1
  fi
fi

echo "‚úÖ All pre-commit checks passed! ($FILE_COUNT file(s) checked)"
